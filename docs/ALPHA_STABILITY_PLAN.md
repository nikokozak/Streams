# Alpha Stability Plan (Ship in 2 Weeks)

This document is the **single execution plan** for two urgent goals:

1) **Option A — One-call AI output** for stream cells: the model returns a **restatement heading + body** in the **same streamed response** (no separate “restatement” request, no special restatement field/UI).
2) **Deep house-cleaning audit**: reduce architectural fragmentation so proxy-only alpha is stable and debuggable.

This is written for an implementation LLM (Claude Code). Follow it as a checklist and keep changes slice-sized.

---

## Non‑Negotiable Invariants (do not violate)

### I1 — Proxy-only means proxy-only
- Ticker must make **zero** vendor API requests to OpenAI/Anthropic/Perplexity (no fallback).
- Ticker must store **no** vendor keys locally (Keychain/UserDefaults/files).
- All LLM calls go through `ProxyLLMService` → `POST /v1/llm/request`.

### I2 — Explicit output contract (no “it happens to work”)
We must treat output format as a **contract**, not an assumption:

- For persisted **stream cells** (Cmd+Enter “think”, regenerate), the model output is **Markdown**.
- The web layer converts streamed Markdown to sanitized HTML on completion:
  - `Ticker/Web/src/hooks/useBridgeMessages.ts` uses `markdownToHtml(...)` on `aiComplete`.
- Persisted `Cell.content` remains **HTML** (current architecture).

### I3 — No duplicate model calls for a single user action
For a single “think” request:
- Do **not** run a separate request to compute a restatement.
- Restatement + body must come from the **same LLM response**.

### I4 — Restatement is not a separate field
Restatement must be user-editable and deletable. Therefore:
- Restatement must live **in the cell content** (as the first block/line), not in `Cell.restatement` nor in a special non-editable header UI.
- `Cell.restatement` becomes **legacy/ignored** (can remain in schema temporarily, but the app should not depend on it).

---

## Track A — Option A: “Heading + Body” from one streamed response

### A0 — Define the on-wire content contract (for “think”)

For **stream cell AI responses** (the “think” flow), the model must output:

1) **First non-empty line**: a Markdown H2 heading of <= 8 words:
   - Format: `## <restatement>`
2) A blank line
3) The body content (Markdown), with subsections using `###` or deeper (avoid additional `##` headings unless absolutely necessary).

Examples:

```md
## Photosynthesis

**Core idea**: …
- …
### Key steps
…
```

Notes:
- The heading must never be `NONE`.
- If the user prompt is already a good heading, reuse it (trimmed).

### A1 — Implement this without cross-layer coupling

**Do not** have Swift “decide markup” by emitting `## ...` itself.
Instead, Swift should request this format via the prompt/contract.

Current state:
- Restatement is generated by a separate proxy call and sent via `restatementGenerated`:
  - `Ticker/Sources/Ticker/App/WebViewManager.swift` (think handler)

Target state:
- The “think” request is **one** streamed proxy call.
- No `restatementGenerated` bridge message exists.

### A2 — Swift changes (Ticker): “think” must use a heading-enabled system prompt

#### Goal
Only the **think/regenerate** path should enforce “Heading + Body”.
Other AI flows should remain unchanged unless explicitly opted in:
- Modifier apply (no heading)
- Block refresh / cascade updates (no heading by default)
- Quick Panel ephemeral chat (no heading by default)

#### Minimal implementation strategy

Add an optional output mode to `AIOrchestrator.route(...)`:
- `includeHeading: Bool = false`

Then:
- `WebViewManager` “think” calls `route(..., includeHeading: true)`
- `ProcessingService` calls `route(..., includeHeading: false)` (default)
- `QuickPanelManager` (Option+Enter ephemeral) calls `route(..., includeHeading: false)` (default)

##### Where to implement the prompt change
Inside `AIOrchestrator.buildRequest(...)`, when `includeHeading == true`, modify the system prompt by using a **dedicated prompt variant** (preferred):
- Add new prompt variants in `Ticker/Sources/Ticker/Services/Prompts.swift`:
  - `thinkingPartnerWithHeading` (for `knowledge` and `ambiguous` intents)
  - `searchWithHeading` (for `search` intent)
- **Note:** Heading is NOT required for modifier intents (`summarize`, `expand`, `rewrite`, `extract`). These use `Prompts.applyModifier` which does not include heading instructions.

Avoid contradictory instructions:
- Existing prompts currently say "DO NOT start with a header—one is provided automatically".
- The heading-enabled variants must remove that line and replace it with the new contract.

#### Remove the old restatement pipeline
Delete/disable, in the “think” handler:
- The `Task { generateRestatement(...) }` block
- The `restatementGenerated` bridge emission
- The persistence write `updateCellRestatement(...)`

Files to touch:
- `Ticker/Sources/Ticker/App/WebViewManager.swift` (remove restatement task)
- Keep `ProxyLLMService.generateRestatement` only if used elsewhere; otherwise mark deprecated.

### A3 — Web changes (Ticker): remove restatement special-casing

Remove or ignore all restatement-specific UI and bridge handlers:
- Remove restatement header rendering in unified editor NodeView:
  - `Ticker/Web/src/extensions/CellBlockView.tsx` (delete `.cell-restatement-header` block)
- Remove `restatementGenerated` handler:
  - `Ticker/Web/src/hooks/useBridgeMessages.ts`

After Option A, the heading is part of streamed Markdown → HTML, so no extra UI is needed.

### A4 — Persistence / legacy data strategy (pick one)

Because existing DB rows may have `Cell.restatement` but not a heading in content, you must choose:

**Option A4.1 (fastest for alpha): accept legacy loss**
- Old cells won’t show their restatement anymore.
- Search titles fall back to `originalPrompt` and/or content snippet.

**Option A4.2 (recommended if you have old data you care about): one-time migration on load**
- When loading a stream, for each `aiResponse` cell:
  - If `cell.restatement` exists AND content does not already start with a heading:
    - Prepend a heading to the content (as HTML) and persist once.
- After migration, the restatement field is ignored.

Do **not** attempt a DB schema migration removing the column during alpha unless you already have migration tooling ready and tested.

### A5 — Verification checklist (Option A)

Manual:
1) Create a stream, type a prompt, press Cmd+Enter.
2) The AI response begins with a heading (H2), then body.
3) You can delete/edit the heading like normal text.
4) There is only **one** proxy request per “think” (no separate restatement request id).

Technical:
- No `restatementGenerated` messages in Web Inspector logs.
- No calls to `generateRestatement(...)` for think flow.

---

## Track A2 — Empty AI cells must “true reset” automatically

### Requirement
If a cell has:
- **no visible characters**, and
- **no embedded blocks** (images/attachments/atoms/mentions),

then it must:
- become `type: text`
- clear AI-only metadata (`originalPrompt`, `modelId`, any AI flags)
- stop being treated as an AI cell everywhere (UI + persistence + downstream behaviors)

### Implementation guidance (unified editor)

You already have a robust emptiness check in `Ticker/Web/src/extensions/CellKeymap.ts` for backspace deletion.

1) Extract it into a shared helper:
   - `Ticker/Web/src/extensions/cellEmpty.ts`
   - `isCellNodeEmpty(cellBlockNode: ProseMirrorNode): boolean`

2) Run auto-reset in **one** place that sees document updates reliably:
   - Preferred: in `UnifiedStreamEditor` `onUpdate` (`handleUpdate`) while iterating `cellBlock` nodes, so the decision is based on the authoritative editor doc.
   - If you do it in `CellBlockView` (NodeView), ensure it cannot double-run across node view lifecycles.

3) Guardrails:
   - never reset while streaming or refreshing (`blockStore.isStreaming/isRefreshing`).
   - reset only on **transition** non-empty → empty (track per-cell previous emptiness in a `ref` or map).

4) Reset action should update:
   - store (`useBlockStore.updateBlock`) for metadata/type
   - persistence (`saveCell`) via the existing debounced save pipeline (or immediate save if you need instant correctness)

### Verification
- Turn a cell into an AI response, then delete all content (including the heading line).
- Cell immediately behaves like a normal text cell (no AI chrome, no AI overlay controls, etc.).
- Reload the app/stream: it stays a text cell.

---

## Track B — Deep House‑Cleaning Audit (Ticker)

### Goal
Stop the “lost the plot” architecture drift by explicitly mapping and then collapsing duplicate paths.
This is not a rewrite: it’s a **targeted cleanup** to reduce coupling and surprise behavior for alpha.

### B0 — Audit deliverables (what you must produce before refactoring)

Create a short markdown report (in the PR description is fine) with:

1) **AI surface map** (where AI is invoked)
   - Stream cell think/regenerate
   - Quick Panel (ephemeral chat)
   - Modifiers (label + apply)
   - Live refresh / cascade updates

2) For each surface, list:
   - entrypoint file/function
   - which Swift service executes the request
   - which bridge messages are emitted
   - what format is streamed (Markdown vs plain text)
   - what is persisted (HTML vs text)

3) **Network boundary map**
   - Identify every place in code with a URLSession request
   - Confirm the only reachable hostnames (in proxy-only alpha) are:
     - `ticker-proxy.fly.dev` (or configured override)
     - Tigris presigned URLs (for feedback attachments)

### B1 — Audit findings (current code, known issues)

These are concrete issues visible in the tree today:

1) Vendor endpoints still exist in source (even if “disabled”)
   - `Ticker/Sources/Ticker/Services/AIService.swift` (`api.openai.com`)
   - `Ticker/Sources/Ticker/Services/AnthropicService.swift` (`api.anthropic.com`)
   - `Ticker/Sources/Ticker/Services/PerplexityService.swift` (`api.perplexity.ai`)
   - `Ticker/Sources/Ticker/Services/EmbeddingService.swift` (`api.openai.com/v1/embeddings`)

2) Vendor services are still instantiated in the central hub
   - `Ticker/Sources/Ticker/App/WebViewManager.swift` initializes `AIService`, `AnthropicService`, `PerplexityService` even though proxy-only is intended.
   - This increases cognitive load and increases the risk of accidental calls / prompts.

3) Mixed output-format assumptions across surfaces
   - Stream cells treat AI output as Markdown (converted to HTML on completion): `Ticker/Web/src/hooks/useBridgeMessages.ts`.
   - Quick Panel appends streamed chunks directly to a string: `Ticker/Sources/Ticker/App/QuickPanel/QuickPanelManager.swift` (may display Markdown literally depending on UI).

4) Stale user-facing messaging
   - `Ticker/Sources/Ticker/Services/Providers/LLMProvider.swift` contains vendor-key error text (“Go to Settings to add your key”) that is incorrect in proxy-only mode.

### B2 — P0 cleanup tasks (minimum to ship reliably)

Do these in separate PRs if needed, but do them all before alpha:

1) **Option A** (above): one-call heading+body, remove restatement special-casing.
2) **Stop instantiating vendor services** in proxy-only alpha:
   - In `WebViewManager`, do not create `AIService/AnthropicService/PerplexityService` when `SettingsService.proxyOnlyMode == true`.
   - Keep the types around only if you need a future dev-only fallback, but ensure they cannot run in alpha builds.
3) **Tripwire**: add a CI/Script check that fails if vendor hostnames appear in buildable codepaths for alpha:
   - Reject strings: `api.openai.com`, `api.anthropic.com`, `api.perplexity.ai`
   - Allowlist only if files are excluded from the target or behind a compile-time flag.
4) **Normalize Quick Panel output**:
   - Decide: Quick Panel either renders Markdown intentionally, or the proxy prompt for Quick Panel is “plain text”.
   - Pick one; document it; make it consistent.
5) **Update stale text**:
   - Remove/adjust any “add API key” UX strings in proxy-only mode.
   - Ensure errors point to “device key in Settings”.

### B3 — P1 cleanup tasks (only if time remains)

1) Reduce the “two sources of truth” confusion in unified editor:
   - Explicitly document: doc is source of truth for **content**, store is source of truth for **metadata**.
   - Or move more metadata into node attrs and serialize exclusively from the editor.
   - Either is acceptable, but **pick one** and enforce it.
2) Remove or fully freeze legacy editor paths (`StreamEditor`) if unified editor is the alpha default.

---

## Execution protocol (how Claude should work)

For each slice:
1) Create a branch and implement only that slice.
2) Provide a summary for GPT review:
   - what changed, files touched, why
   - acceptance criteria checklist
   - risks / rollback
3) Only after review, proceed to the next slice.

Recommended slicing order:
1) Option A: remove restatement special-casing + prompt contract for heading+body
2) Empty-cell true reset
3) Remove vendor service instantiation + update stale strings
4) Quick Panel output normalization
5) Tripwire (CI/script)

